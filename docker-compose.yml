services:
  iot-mcp:
    build: .
    container_name: iot-mcp-claude
    restart: unless-stopped
    ports:
      - "3300:3000"
    # VPN capabilities
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    # Uncomment for serial device passthrough:
    #   - "/dev/ttyUSB0:/dev/ttyUSB0"
    #   - "/dev/ttyUSB1:/dev/ttyUSB1"
    volumes:
      - ./devices.json:/app/devices.json:ro
      # VPN configs
      - ./vpn/openvpn:/etc/openvpn/client:ro
      - ./vpn/wireguard:/etc/wireguard:ro
      - tailscale_state:/var/lib/tailscale
      - zerotier_state:/var/lib/zerotier-one
    env_file:
      - .env
    environment:
      - SSE_HOST=0.0.0.0
      - SSE_PORT=3000
      - DEVICES_FILE=/app/devices.json
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      # Tailscale (set TS_AUTHKEY in .env to enable)
      # - TS_EXTRA_ARGS=--advertise-tags=tag:server
      # Cloudflare Tunnel (set CF_TUNNEL_TOKEN in .env to enable)
      # ZeroTier (set ZT_NETWORKS in .env, comma-separated network IDs)
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

volumes:
  tailscale_state:
  zerotier_state:
